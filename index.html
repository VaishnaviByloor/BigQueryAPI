<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Contactless activity</title>
		<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.js"></script> 
		<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/postmonger@0.0.16/postmonger.js"></script>
		<script type="text/javascript">
			(function() {
				var config = {
					baseUrl: ''
				};
				var dependencies = [
					'customActivity'
				];
				require(config, dependencies);
			})();
		</script>
		
		<style type="text/css">
		   	.step {
				display: none;
			}
			#step1 {
				display: block;
			}
			.smile{ background:#fff;border:0px}
		</style>
	</head>
		<body style="background: #3f86f1 url(https://media1.giphy.com/media/l46CmCB7Ka2PBLE1G/source.gif) no-repeat right -152px;color:#fff">
	<div id="step1" class="step">
		<div class="section">
			<div class="container">
				<div class="row">
				
					<div class="col-md-12"><br/><br/>
							<p><B>Contactless custom Activity by AVIS</B><BR/><br/>
							This Custom Activity sends the data captured from ODB <br/>Payload to the Contactless CloudPage<br/>Press Done and Next</p>
								
						
						<br/>
							<div class="md-form" style="width:100px">
							  <textarea id="select1" class="" rows="1" style="display:none" readonly>Contactless ready! </textarea><br/>
                <input type="hidden" id="contactkey" name="contactkey"></input>
								<p style="background: #fff;
    border-radius: 5px;
    padding: 10px;display:none">
							 
							   <button class="smile" >â˜€</button>
							 
							  </p>
							  <a href="#" class="btn btn-warning" style="width:100%" id="select2">Done</a>
							  
							</div>
						</div>
					
					<div class="col-md-6" style="margin-top:24px;display:none" >
						<br/>
							<div class="md-form">
							  <div id="select10" class="" rows="3" ></div>
							 <br/>
							</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="step2" class="step">
		<div class="section">
			<div class="container">
				<div class="row">
				
								
						
							<div class="col-md-12" style="margin-top: 61px;">
						<br>
							<div class="md-form">
							  <div id="message" class="" rows="3"></div>
							 <br>
							</div>
					
						</div>
					
				</div>
			</div>
		</div>
	</div>	
  <script>
	   var position;
	
    function getCaretPosition() {
        var ctlTextArea = document.getElementById('select1');
        position = ctlTextArea.selectionStart;
        return position;
    }
	
	/* Needs JQuery */
    $(document).ready(function () {

        jQuery.fn.extend({
            insertAtCaret: function (myValue) {
                return this.each(function (i) {
                    if (document.selection) {
                        //For browsers like Internet Explorer
                        this.focus();
                        sel = document.selection.createRange();
                        sel.text = myValue;
                        this.focus();
                    }
                    else if (this.selectionStart || this.selectionStart == '0') {
                        //For browsers like Firefox and Webkit based
                        var startPos = this.selectionStart;
                        var endPos = this.selectionEnd;
                        var scrollTop = this.scrollTop;
                        this.value = this.value.substring(0, startPos) + myValue + this.value.substring(endPos, this.value.length);
                        this.focus();
                        this.selectionStart = startPos + myValue.length;
                        this.selectionEnd = startPos + myValue.length;
                        this.scrollTop = scrollTop;
                    } else {
                        this.value += myValue;
                        this.focus();
                    }
                })
            }
        });

        $('.smile').click(function () {
            $("#select1").insertAtCaret($(this).html());
        });

    });
		</script>
			 <script src="https://cdnjs.cloudflare.com/ajax/libs/jsrsasign/8.0.20/jsrsasign-all-min.js"></script>
<script>
  var token = '';
  var pHeader = {
    "alg":"RS256","typ":"JWT"}
  var sHeader = JSON.stringify(pHeader);
  var pClaim = {
  };
  pClaim.aud = "https://accounts.google.com/o/oauth2/token";
  pClaim.scope = "https://www.googleapis.com/auth/bigquery";
  pClaim.iss = "dwprodsu-bq-crm-service-acct@lively-encoder-854.iam.gserviceaccount.com";
  pClaim.exp = KJUR.jws.IntDate.get("now + 1hour");
  pClaim.iat = KJUR.jws.IntDate.get("now");
  var sClaim = JSON.stringify(pClaim);
  var key = "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCdcm2EFOPCc1yI\n7+FUiSbxwj28dEgIigxOVbvFygvPUFYK6zctuRMF+S91hIG6HtBNgxRMOoIIDf9R\ngOyPGgyjlHllrC5y/k1gvBTKSSJWSF/rHYL1RsK2/l2RdTogO9NpaOUHFieFnjI+\nHgb3ozOEnWeSrVvpdtfj3fZt5prRgxc10fd337ViCoOYsskZSve8iWIXY3kNUDSU\nPD4aoshX+Pz/l6Y0Y9nM/9zWzQkjDx90EPJdV61HrSCuTu85OIrJZEbaIrstW13f\nCe15h3W8HzRx2YkkcHSUt0wk6c9A05TLPYgVq3VD/G/04/PAIfxuu38Useyg/Alz\nF8FcJ1f3AgMBAAECggEAC65Ry12kuNLyjQ2a8+N0WmBU+zZ3TPw3myzc0E5D9Qla\nm4HFkg9Whs1sxMpkDikQvtzC30BB+xNVcLhgvzcpXo4lOYf+LuAzYRdjGs+KjB3f\ne+PbHj5giM9d+sIt4fao9yY7Q6d+9CNUn+t+DID0/AQ/ixAbLxAhm+a7odNc2L6Z\nRz0yzmcLuldLszHRSL0CrMjGPS5QXOrHmRTsfazgr/lpIFg1w1DSKAQtYgKPP1ng\n9gX4FmD8uyqWJZP6jz0GmbE3235prZGPSsj6dFobZQXm0W6P6w5cDAqplyVnga4V\nxX11HHVHVtweShVgCmAnfBJ4jpM7zdtN2G8S2/2wUQKBgQDdCU6c4l2lRRYdJ0Ko\nT9gFCOa8+Dd8twn5IoBH3TO6Yl05vQJpfXaj3WvV6uwWUCZpRGGMD0lH6QABF52p\nNgX9v/dCQBgUBpkimWwAup+A4nHXrt2thsk3A2CwynxECs+zMkl0g30rkdK3oumv\n/7afBFS3Rg3YZkOOi0/wQ3HIhwKBgQC2Wh6GI5QCnS1d6gJDYn2/BIB21/DAIq+c\n/QN+aK0jRgLC3ExzHqL//of+IuTJjMMMqaEpDZAmTYn/R0CeV2QxMUZlQjIvY1AZ\nbxwJ5bB75PSQcGOJUv8Z/UV/OJvBQxOgZvvjzZYQ0zr0mrB3l2BKBOsPdp5oZY4+\nNkv91EuBEQKBgGEq2D4rXNNsfX4vZiQrhWEhOp3T2EChDmdQ/WeaHEVRPH5HUqoh\nF2iNy/vsHADrFxerkd5KUgKksPXJ9esO7q9QFlgvaOZUyDjnjQz8/WVhJn6URqsj\n14yxlW3idaJLxmaWMqhfrUTcA+/qVCSkmxlog/1VdHyu5//fyjJq07g9AoGAWafJ\nZi5L8VUSHyCU6EiehrJR7xyQtAbZzRfhBd+1cKhVZzUlKVygy7h7aIoDbs0UgT9N\ni3+tpgdtl+OSc8eH7V/KurJnNkFf+oFUidEyilexnuqDJdt2rXKHHtvYSJcQKUc5\nBXHpHHCehfEgXkxA/WOZpsqta6qy2webKTudu+ECgYEAo/z5ku9MzKmLdVLU1FGa\nlUYmoqr6EIRgnFXgZK+ysUundbDg+maQPBUNRSJLVnG/U8xSyeYzyOFWRFamSBgU\nFmRctHDaDiFlPp5PXNaUJRtkAxEWK7rAEQcGHZA7QjZJvbiHMev2pR1Kt3RaLu5e\nCParVyHj5Xty7Y/iExZdKgA=\n-----END PRIVATE KEY-----\n"
  var sJWS = KJUR.jws.JWS.sign(null, sHeader, sClaim, key);
  var XHR = new XMLHttpRequest();
  var urlEncodedData = "";
  var urlEncodedDataPairs = [];
  urlEncodedDataPairs.push(encodeURIComponent("grant_type") + '=' + encodeURIComponent("urn:ietf:params:oauth:grant-type:jwt-bearer"));
  urlEncodedDataPairs.push(encodeURIComponent("assertion") + '=' + encodeURIComponent(sJWS));
  urlEncodedData = urlEncodedDataPairs.join('&').replace(/%20/g, '+');
  XHR.onreadystatechange = function() {
    if (XHR.readyState == 4 && XHR.status == 200) {
      var response = JSON.parse(XHR.responseText);
      token = response["access_token"];
	    console.log(token);
 document.getElementById("contactkey").value = token;
	      console.log('after assigning to contactkey:', document.getElementById("contactkey").value);

    }
  }
  // We define what will happen in case of error
  XHR.addEventListener('error', function(event) {
    console.log('Oops! Something went wrong.');
  }
                      );
  XHR.open('POST', 'https://accounts.google.com/o/oauth2/token');
  XHR.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded','Access-Control-Allow-Origin','*');
  XHR.send(urlEncodedData)

</script>
	</body>
</html>
